---
layout: post
title:  Windows Implementation Libraries (WIL)
categories: [Useful]
---

During NDIS internals research something *suspicious* was found

![dt ndis!_NDIS_MINIPORT_BLOCK]({{ '/images/24102025/2025-10-24-0.jpg' | relative_url }})
<div class="emphasizer_img_text">ndis!_NDIS_MINIPORT_BLOCK</div>


Something like:
```cpp
wil::unique_any_t<wil::details::unique_storage<wil::details::resource_policy<NDISWATCHDOG__ *,void (cdecl*)(NDISWATCHDOG *),&ndisFreeWatchdog,wistd::integral_constant<unsigned int64,1>,NDISWATCHDOG *,-1,std::nullptr_t> > >
```
This is from Windows Implementation Libraries ([WIL](https://github.com/microsoft/wil)), it is a header only library, just download and use:
```cpp
#include "wil\resource.h"
```

Usage:

```c
NTSTATUS example_1()
{
    lock_acquire(&lock);
    lock->owner = KeGetCurrentThread();

    auto guard = wil::scope_exit([&]() {
        lock->owner = nullptr;
        lock_release(&lock);
    });

     if ( . . . failure . . .)
         return STATUS_UNSUCCESSFUL; // lock is released via wil::scope_exit

     return STATUS_SUCCESS; // lock is released via wil::scope_exit
}


NTSTATUS example_2()
{
    RETURN_IF_NTSTATUS_FAILED(ZwCreateFile(. . . ));
    return STATUS_SUCCESS;
}
```


So, if someone want to use C++ in the drivers, <span class="emphasizer_code_function">WIL</span> can be considered for sure:

![C++ configuration]({{ '/images/24102025/2025-10-24-1.jpg' | relative_url }})
<div class="emphasizer_img_text">C++ driver configuration (MSVC)</div>
